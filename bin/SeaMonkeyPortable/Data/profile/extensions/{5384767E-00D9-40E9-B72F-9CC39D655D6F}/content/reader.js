/*
 EPUBReader Firefox Extension: http://www.epubread.com/
 Copyright (C) 2014 Michael Volz (epubread@gmail.com)

 This program is free software: you can redistribute it under
 the terms of the attached license (license.txt).

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 attached license (license.txt) for more details.

 You should have received a copy of the license (license.txt)
 along with this program. If not, see <http://www.epubread.com/license/>.
*/
Components.utils.import("chrome://epubreader/content/Epubreader.jsm");
var reader={nav_forwards:1,nav_backwards:2,page_forwards:1,page_backwards:2,f:1,o:2,i:10,r:6,c:1,j:!1,k:!1,e:null,q:!1,h:null,n:null,d:null,b:null,m:null,t:null,init:function(){reader.s(0)},s:function(a,c){var b=window.location.href;if(-1!=b.lastIndexOf("=")){reader.b=Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefService).getBranch("extensions.epubreader.");reader.b.QueryInterface(Components.interfaces.nsIPrefBranch2);reader.b.addObserver("",reader,
!1);var d=Components.classes["@mozilla.org/xre/app-info;1"].getService(Components.interfaces.nsIXULAppInfo),e=Components.classes["@mozilla.org/xpcom/version-comparator;1"].getService(Components.interfaces.nsIVersionComparator),f=document.getElementById("content_frame");0==a?(a++,f.addEventListener("load",reader.load,!0),Epubreader.getEpub(reader.s,a,b.substr(b.lastIndexOf("=")+1))):1==a?(a++,reader.e=c[0],utils.registerCSS(!1),d=utils.G(reader.e.url),e=document.getElementById("nav_frame"),e.contentWindow.location=
d,b=e.docShell,"charset"in b||(b=b.QueryInterface(Components.interfaces.nsIDocCharset)),b.charset="UTF-8",reader.A(),d=reader.b.getBoolPref("js_enabled"),e=reader.b.getBoolPref("plugins_enabled"),b=f.docShell,b.allowAuth=!1,b.allowMetaRedirects=!1,b.allowPlugins=e,b.allowJavascript=d,Epubreader.getBookmarkByName(reader.s,a,reader.e.id,"standard")):2==a&&(reader.m=c[0],reader.m?(b=reader.e.url+"/"+reader.m.page,f.addEventListener("load",reader.scrollTo,!0)):b=reader.e.url+"/"+reader.e.first,f.contentWindow.location=
b,b=f.docShell,"charset"in b||(b=b.QueryInterface(Components.interfaces.nsIDocCharset)),b.charset="UTF-8",document.title=reader.e.title+" - "+reader.e.author,reader.c=1,reader.enable(),document.getElementById("library").disabled=!1,document.getElementById("save").disabled=!1,document.getElementById("bookmark").disabled=!1,document.getElementById("font_size_less").disabled=!1,document.getElementById("font_size_more").disabled=!1,0>e.compare(d.platformVersion,"1.9.2")&&(document.getElementById("reading_style").hidden=
!0,document.getElementById("reading_style_spacer").hidden=!1),reader.n=reader.b.getBoolPref("paging_click_enabled"),reader.h=reader.b.getBoolPref("toolbar_locked"),!0==reader.h?(document.getElementById("navigationbar").hidden=!1,document.getElementById("toolbar_locked").setAttribute("checked","true")):document.getElementById("navigationbar_toggle").hidden=!1,d=reader.b.getIntPref("width.frame.left"),document.getElementById("nav_frame_box").width=d,!0==reader.b.getBoolPref("toc_collapsed")&&document.getElementById("epub_grippy").click(),
f.contentWindow.focus())}},unload:function(){dump("unload\n");reader.b&&reader.b.removeObserver("",reader)},scrollTo:function(){document.getElementById("content_frame").removeEventListener("load",reader.scrollTo,!0);utils.I(reader.m.text)},load:function(){var a=document.getElementById("content_frame"),c=a.contentDocument.location.href;a.contentDocument.addEventListener("keydown",utils.J,!0);reader.H(c);dump("load: "+reader.c+"\n");reader.F();a.contentWindow.focus();reader.P();c=a.docShell;"charset"in
c?c.charset="UTF-8":c.QueryInterface(Components.interfaces.nsIDocCharset).charset="UTF-8";if(reader.d==reader.f)a.contentWindow.addEventListener("resize",utils.resize,!0),a.contentWindow.addEventListener("scroll",utils.scroll,!0),!0==reader.n&&a.contentDocument.addEventListener("click",reader.click,!0),a.contentDocument.documentElement.style.height=a.contentWindow.innerHeight-2*reader.r+"px",a.contentWindow.scrollbars.visible=!1,!0==reader.q&&(a.contentWindow.scrollTo(a.contentWindow.scrollMaxX,0),
reader.q=!1),utils.B();else{a.contentWindow.scrollbars.visible=!0;var b=document.getElementById("scrollbar_helper");b.hidden=!1;window.setTimeout(function(){b.hidden=!0},100)}reader.enable()},H:function(a){var c=document.getElementById("nav_frame").contentDocument.getElementById("spine").getElementsByTagNameNS("*","a");a=decodeURI(a);for(var b=0;b<c.length;b++)if(a.match(RegExp(decodeURI(c[b].href)+".*"))){reader.c=parseInt(c[b].getAttribute("id"));break}},F:function(){reader.t=document.getElementById("nav_frame").contentDocument.getElementById("spine").getElementsByTagNameNS("*",
"a").length},navigateSpine:function(a){if(a==reader.nav_forwards&&reader.k||a==reader.nav_backwards&&reader.j)a==reader.nav_forwards?reader.c+=1:a==reader.nav_backwards&&(reader.c-=1);reader.R(a);document.getElementById("content_frame").focus()},click:function(a){var c=document.getElementById("content_frame").contentWindow,b=c.innerWidth;a=a.pageX-c.scrollX;100>=a?reader.page(reader.page_backwards):100>=b-a&&reader.page(reader.page_forwards)},V:function(a){a.detail&&(0<a.detail?reader.page(reader.page_forwards):
reader.page(reader.page_backwards))},page:function(a){var c=document.getElementById("content_frame"),b=c.contentWindow,d=b.scrollX;a==reader.page_backwards?(utils.l=!1,b.scroll(b.scrollX-b.innerWidth-reader.i,0)):(utils.l=!1,b.scroll(b.scrollX+b.innerWidth+reader.i,0));d==b.scrollX?(utils.l=!0,a==reader.page_forwards?!0==reader.k&&(reader.navigateSpine(reader.nav_forwards),a=document.getElementById("nav_forwards"),c.contentWindow.location=a):a==reader.page_backwards&&!0==reader.j&&(reader.navigateSpine(reader.nav_backwards),
a=document.getElementById("nav_backwards"),reader.q=!0,c.contentWindow.location=a)):reader.enable()},enable:function(){posForwards=reader.c+1;posBackwards=reader.c-1;var a=document.getElementById("nav_frame").contentDocument,c=a.getElementById(posForwards),b=document.getElementById("nav_backwards_img"),d=document.getElementById("nav_forwards_img"),e=document.getElementById("nav_backwards_button"),f=document.getElementById("nav_forwards_button");a.getElementById(posBackwards)?(b.src="chrome://epubreader/skin/nav_backwards_enabled.png",
e.disabled=!1,reader.j=!0):(b.src="chrome://epubreader/skin/nav_backwards_disabled.png",e.disabled=!0,reader.j=!1);c?(d.src="chrome://epubreader/skin/nav_forwards_enabled.png",f.disabled=!1,reader.k=!0):(d.src="chrome://epubreader/skin/nav_forwards_disabled.png",f.disabled=!0,reader.k=!1);a=document.getElementById("nav_page_backwards_img");c=document.getElementById("nav_page_forwards_img");b=document.getElementById("nav_page_backwards_button");d=document.getElementById("nav_page_forwards_button");
reader.j?(a.src="chrome://epubreader/skin/nav_page_backwards_enabled.png",b.disabled=!1):(e=document.getElementById("content_frame").contentWindow,0<e.scrollX?(a.src="chrome://epubreader/skin/nav_page_backwards_enabled.png",b.disabled=!1):(a.src="chrome://epubreader/skin/nav_page_backwards_disabled.png",b.disabled=!0));reader.k?(c.src="chrome://epubreader/skin/nav_page_forwards_enabled.png",d.disabled=!1):(e=document.getElementById("content_frame").contentWindow,e.scrollX==e.scrollMaxX?(c.src="chrome://epubreader/skin/nav_page_forwards_disabled.png",
d.disabled=!0):(c.src="chrome://epubreader/skin/nav_page_forwards_enabled.png",d.disabled=!1))},R:function(a){var c=document.getElementById("nav_frame").contentDocument,b=document.getElementById("nav_forwards"),d=document.getElementById("nav_backwards");a==reader.nav_forwards?(b.href=c.getElementById(reader.c),dump("forwards: "+reader.c+"\n")):a==reader.nav_backwards&&(d.href=c.getElementById(reader.c),dump("backwards: "+reader.c+"\n"))},P:function(){for(var a=document.getElementById("content_frame"),
c=a.contentDocument.getElementsByTagNameNS("*","a"),b=0;b<c.length;b++)c[b].href.match(/http.*/)&&(c[b].target="_blank");c=a.contentWindow.innerHeight-2*reader.r;a=a.contentDocument.getElementsByTagNameNS("*","img");for(b=0;b<a.length;b++)a[b].removeAttribute("alt"),a[b].removeAttribute("title"),a[b].removeAttribute("height"),a[b].removeAttribute("width"),a[b].style.maxHeight=c+"px"},A:function(){reader.d=reader.b.getIntPref("paging_dir.content");var a=document.getElementById("nav_backwards_button"),
c=a.getAttribute("tooltiptext").split(/\//)[0],b=document.getElementById("nav_forwards_button"),d=b.getAttribute("tooltiptext").split(/\//)[0],e=document.getElementById("nav_page_backwards_button"),f=document.getElementById("nav_page_forwards_button"),g=document.getElementById("progress_meter_box"),h=document.getElementById("progress_meter_toggle_box");reader.d==reader.f?(e.hidden=!1,f.hidden=!1,a.style.marginRight="0px",a.setAttribute("tooltiptext",c),b.style.marginLeft="0px",b.setAttribute("tooltiptext",
d),g.hidden=!1,h.hidden=!1):(e.hidden=!0,f.hidden=!0,a.style.marginRight="3px",a.setAttribute("tooltiptext",c+"/<-"),b.style.marginLeft="3px",b.setAttribute("tooltiptext",d+"/->"),g.hidden=!0,h.hidden=!0)},observe:function(a,c,b){"nsPref:changed"==c&&"paging_dir.content"==b&&reader.A()}},utils={K:37,L:39,M:46,N:107,O:109,u:null,w:null,v:null,U:2,zoom_smaller:1,zoom_larger:2,l:!0,p:null,init:function(){var a=utils.a("shortcut.catalog");utils.v=a.charCodeAt(0);a=utils.a("shortcut.save");utils.w=a.charCodeAt(0);
a=utils.a("shortcut.bookmark");utils.u=a.charCodeAt(0);!1==reader.b.getBoolPref("toolbar_hint_shown")&&document.getElementById("navigationbar").addEventListener("mouseover",utils.showToolbarNotification,!0);!1==reader.b.getBoolPref("paging_hint_shown")&&document.getElementById("content_frame").addEventListener("mouseover",utils.showPagingNotification,!0)},J:function(a){!1==a.ctrlKey&&!1==a.metaKey&&!1==a.altKey&&(a.keyCode==utils.K?(a.preventDefault(),reader.page(reader.page_backwards)):a.keyCode==
utils.L?(a.preventDefault(),reader.page(reader.page_forwards)):a.keyCode==utils.M?(a.preventDefault(),document.getElementById("epub_grippy").click()):a.keyCode==utils.N?(a.preventDefault(),utils.zoomFont(utils.zoom_larger)):a.keyCode==utils.O?(a.preventDefault(),utils.zoomFont(utils.zoom_smaller)):a.keyCode==utils.u?(a.preventDefault(),utils.setBookmark()):a.keyCode==utils.w?(a.preventDefault(),utils.save()):a.keyCode==utils.v&&(a.preventDefault(),utils.openPage("catalog")))},zoomFont:function(a){var c=
document.getElementById("content_frame"),b=reader.b.getCharPref("font.size.content");"parent"==b&&(b="12pt");b=parseInt(b);a==utils.zoom_smaller&&1<b?b-=1:a==utils.zoom_larger&&30>b&&(b+=1);reader.b.setCharPref("font.size.content",b+"pt");Epubreader.updateCSS();utils.registerCSS(!0);c.contentWindow.location.reload()},resize:function(){dump("resize\n");contentFrame=document.getElementById("content_frame");contentFrame.contentDocument.documentElement.style.height=contentFrame.contentWindow.innerHeight-
2*reader.r+"px";utils.p&&window.clearTimeout(utils.p);utils.p=window.setTimeout(utils.Q,150)},Q:function(){dump("resize finished\n");utils.p=null;document.getElementById("content_frame").contentWindow.location.reload()},scroll:function(){if(!0==utils.l){var a=document.getElementById("content_frame").contentWindow,c=a.innerWidth+reader.i,b=a.scrollX/c,b=0.5>b-Math.floor(a.scrollX/c)?Math.floor(a.scrollX/c):Math.ceil(a.scrollX/c);a.scrollX/c!=b&&a.scrollTo(b*c,0)}else utils.l=!0;utils.B()},B:function(){var a=
document.getElementById("content_frame").contentWindow,c=document.getElementById("progress_meter_flex"),b=document.getElementById("progress_meter_toggle"),d=document.getElementById("progress_meter_toggle_flex"),e=100/reader.t,a=e*(reader.c-1)+(0==a.scrollX&&0==a.scrollMaxX?100:Math.floor(a.scrollX/a.scrollMaxX*100))/100*e;document.getElementById("progress_meter").flex=a;c.flex=100-a;b.flex=a;d.flex=100-a},saveWidth:function(){var a=document.getElementById("nav_frame").clientWidth;0<a?(reader.b.setIntPref("width.frame.left",
a),reader.b.setBoolPref("toc_collapsed",!1)):reader.b.setBoolPref("toc_collapsed",!0)},setBookmark:function(){var a=unescape(document.getElementById("nav_frame").contentDocument.getElementById(reader.c).getAttribute("href")),a=a.replace(/'/g,"''"),c=utils.C(),c=c.replace(/'/g,"''");dump(c);var b=[];b.id=reader.e.id;b.name="standard";b.page=a;b.text=c;Epubreader.storeBookmark(b);try{var d=Components.classes["@mozilla.org/alerts-service;1"].getService(Components.interfaces.nsIAlertsService),c=utils.a("bookmark.set");
d.showAlertNotification("","",c,!1,"",null)}catch(e){}},C:function(){function a(a){return a=a.replace(/^\s*/,"").replace(/\s*$/,"")}var c="",b=document.getElementById("content_frame"),d=b.contentWindow,b=b.contentDocument,e=d.innerHeight/2,f=b.getElementsByTagNameNS("*","body")[0],g=(window.outerWidth-window.innerWidth)/2+window.innerWidth+window.screenX-d.innerWidth,h=d.scrollX,k=d.scrollY;!0==reader.n&&b.removeEventListener("click",reader.click,!0);reader.d==reader.f?(utils.g(f,g+h,0,{type:"mousedown"}),
utils.g(f,g+h,e,{type:"mousemove"}),utils.g(f,g+h,e,{type:"mouseup"})):(utils.g(f,g,k,{type:"mousedown"}),utils.g(f,g,k+e,{type:"mousemove"}),utils.g(f,g,k+e,{type:"mouseup"}));!0==reader.n&&b.addEventListener("click",reader.click,!0);e=d.getSelection();f=e.toString();0<f.length?(split=f.split(/[\f\n\r\t\v]+/,2),split[0]=a(split[0]),split[1]&&(split[1]=a(split[1])),f=split[1]?5>split[0].length&&split[1].length>split[0].length?split[1]:split[0]:split[0],f=f.substr(0,150),5<=f.length&&(c=f)):dump("no text found.\n");
if(""!=c){h=d.scrollX;k=d.scrollY;for(b=0;;)if(!0==d.find(c,!1,!0,!1,!1,!1,!1))b++;else break;b++;c="<text pos="+b+" />"+c;reader.d==reader.o&&d.scrollTo(0,k)}else if(c=utils.D()){d=c.tagName.toLowerCase();b=b.getElementsByTagNameNS("*",d);for(k=0;k<b.length&&b[k]!=c;k++);c='<tag name="'+d+'" pos='+k+" />"}else c="<scroll dir="+reader.d+" pos="+(reader.d==reader.f?h:k)+" />";e.removeAllRanges();return c},D:function(){var a=document.getElementById("content_frame"),c=a.contentDocument,b=a.contentWindow.innerWidth,
a=a.contentWindow.innerHeight,d=null,e=0;a:for(;e<a;e+=5)for(var f=0;f<b;f+=5){var g=c.elementFromPoint(f,e);if(g.tagName.match(/.*[^html|body]/i)&&0<=g.getBoundingClientRect().left){d=g;break a}}return d},I:function(a){var c=document.getElementById("content_frame"),b=c.contentWindow,c=c.contentDocument;if(a&&""!=a)if(dump("goToBookmark: "+a+"\n"),a.match(/<text.*>/)){a=a.match(/<text pos=(.*) \/>(.*)/);var d=a[1];a=a[2];for(var e=0;e<d;e++)var f=b.find(a,!1,!1,!1,!1,!1,!1);!0==f?(dump("goToBookmark: found.\n"),
reader.d==reader.f&&(d=b.getSelection(),a=d.getRangeAt(0),"getClientRects"in a?(c=window.getComputedStyle(c.getElementsByTagNameNS("*","body")[0],null),c=parseInt(c.marginLeft)+parseInt(c.paddingLeft),a=a.getClientRects()[0].left-c,c=b.innerWidth+reader.i,a=Math.floor(a/c),b.scrollTo(a*c,0)):(c=d.anchorNode,c.nodeType==Components.interfaces.nsIDOMNode.TEXT_NODE&&(c=c.parentNode),c.scrollIntoView(),a=d.anchorNode.textContent,c=a.replace(/^\s*/,""),0<d.anchorOffset-(a.length-c.length)&&(dump("goToBookmark: one page forward\n"),
a=b.scrollX,c=b.innerWidth+reader.i,a=Math.floor(a/c),b.scrollTo((a+1)*c,0)))),d=b.getSelection(),d.removeAllRanges()):dump("goToBookmark: not found.\n")}else a.match(/<tag.*>$/)?(a=a.match(/<tag name="(.*)" pos=(.*) .*/),b=a[1],d=parseInt(a[2]),c=c.getElementsByTagNameNS("*",b)[d],c.scrollIntoView()):a.match(/<scroll.*>$/)&&(a=a.match(/<scroll dir=(.*) pos=(.*) .*/),c=a[1],d=a[2],c==reader.d&&(c==reader.f?b.scrollTo(d,0):c==reader.o&&b.scrollTo(0,d)));else dump("goToBookmark: bookmark text is empty.\n")},
a:function(a){return Components.classes["@mozilla.org/intl/stringbundle;1"].getService(Components.interfaces.nsIStringBundleService).createBundle("chrome://epubreader/locale/epubreader.properties").GetStringFromName(a)},T:function(){try{var a=Components.classes["@mozilla.org/chrome/chrome-registry;1"].getService();a.QueryInterface(Components.interfaces.nsIXULChromeRegistry);var c=a.QueryInterface(Components.interfaces.nsIToolkitChromeRegistry).getSelectedLocale("epubreader")}catch(b){c=""}return c},
registerCSS:function(a){var c="file:///"+Epubreader.getEpubRoot().replace(/\\/g,"/")+"/epub.css",b=Components.classes["@mozilla.org/content/style-sheet-service;1"].getService(Components.interfaces.nsIStyleSheetService),c=Components.classes["@mozilla.org/network/io-service;1"].getService(Components.interfaces.nsIIOService).newURI(c,null,null);b.sheetRegistered(c,b.USER_SHEET)&&!0==a&&b.unregisterSheet(c,b.USER_SHEET);b.sheetRegistered(c,b.USER_SHEET)||b.loadAndRegisterSheet(c,b.USER_SHEET)},save:function(){picker.save(0,
null,reader.e.id)},simulateClick:function(a){var c=document.createEvent("MouseEvents");c.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null);a.dispatchEvent(c)},g:function(a,c,b,d){var e=window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).getInterface(Components.interfaces.nsIDOMWindowUtils),f=d.button||0,g=d.S||1;a=a.getBoundingClientRect();e.sendMouseEvent(d.type,a.left+c,a.top+b,f,g,0)},toggleNavigationbar:function(a){if(!1==reader.h){var c=document.getElementById("navigationbar");
a.pageY<window.innerHeight-c.clientHeight+4&&(c.hidden=!0,document.getElementById("navigationbar_toggle").hidden=!1)}},lockToolbar:function(){reader.h=document.getElementById("toolbar_locked").hasAttribute("checked");reader.b.setBoolPref("toolbar_locked",reader.h);if(!0==reader.h)document.getElementById("navigationbar").hidden=!1,document.getElementById("navigationbar_toggle").hidden=!0;else{document.getElementById("navigationbar").hidden=!0;document.getElementById("navigationbar_toggle").hidden=
!1;var a=Components.classes["@mozilla.org/alerts-service;1"].getService(Components.interfaces.nsIAlertsService),c=utils.a("toolbar.hint.unlocked");a.showAlertNotification("","",c,!1,"",null)}},toggleReadingStyle:function(){reader.d==reader.f?(reader.b.setIntPref("paging_dir.content",reader.o),reader.b.setCharPref("count.column.content","single")):(reader.b.setIntPref("paging_dir.content",reader.f),reader.b.setCharPref("count.column.content","auto"));Epubreader.updateCSS();utils.registerCSS(!0);document.getElementById("content_frame").contentWindow.location.reload()},
showToolbarNotification:function(){var a=Epubreader.readURL("chrome://epubreader/content/toolbar_notification_template.html"),c=a.substring(a.search(/%repeat-begin%/)+14,a.search(/%repeat-end%/)),b=a.substring(a.search(/%paging-vertical-begin%/)+23,a.search(/%paging-vertical-end%/)),d=a.substring(a.search(/%paging-horizontal-begin%/)+25,a.search(/%paging-horizontal-end%/)),e="",c=c.replace(/%hint_bar_hide%/,utils.a("toolbar.hint.hide")),c=c.replace(/%hint_bar_keyboard%/,utils.a("toolbar.hint.keyboard")),
c=c.replace(/%hint_bar_keyboard_catalog%/,utils.a("toolbar.hint.keyboard.catalog")),c=c.replace(/%shortcut_catalog%/,utils.a("shortcut.catalog")),c=c.replace(/%hint_bar_keyboard_save%/,utils.a("toolbar.hint.keyboard.save")),c=c.replace(/%shortcut_save%/,utils.a("shortcut.save")),c=c.replace(/%hint_bar_keyboard_bookmark%/,utils.a("toolbar.hint.keyboard.bookmark")),c=c.replace(/%shortcut_bookmark%/,utils.a("shortcut.bookmark")),c=c.replace(/%hint_bar_keyboard_fontsize%/,utils.a("toolbar.hint.keyboard.fontsize")),
c=c.replace(/%hint_bar_keyboard_toc%/,utils.a("toolbar.hint.keyboard.toc")),c=c.replace(/%direction%/g,utils.a("lang.direction"));reader.d==reader.o?(b=b.replace(/%hint_bar_keyboard_linewise%/,utils.a("toolbar.hint.keyboard.linewise")),b=b.replace(/%hint_bar_keyboard_pagewise%/g,utils.a("toolbar.hint.keyboard.pagewise")),b=b.replace(/%hint_bar_keyboard_chapterwise%/,utils.a("toolbar.hint.keyboard.chapterwise"))):b=d.replace(/%hint_bar_keyboard_pagewise%/g,utils.a("toolbar.hint.keyboard.pagewise"));
e=c.replace(/%paging%/,b);a=a.replace(/%repeat-begin%(.|\s)*%paging-horizontal-end%/,e);document.getElementById("notification").innerHTML=a;a=document.getElementById("notification_box");a.hidden=!1;a=document.getElementById("navigationbar");a.removeEventListener("mouseover",utils.showToolbarNotification,!0);reader.b.setBoolPref("toolbar_hint_shown",!0)},showPagingNotification:function(){var a=Epubreader.readURL("chrome://epubreader/content/paging_notification_template.html"),c="",b=a.substring(a.search(/%repeat-begin%/)+
14,a.search(/%repeat-end%/)),b=b.replace(/%paging_hint_title%/,utils.a("paging.hint.title")),b=b.replace(/%paging_hint_general%/,utils.a("paging.hint.general")),b=b.replace(/%paging_hint_paging%/,utils.a("paging.hint.paging")),b=b.replace(/%paging_hint_preferences%/,utils.a("paging.hint.preferences")),b=b.replace(/%paging_hint_change%/,utils.a("paging.hint.change")),b=b.replace(/%paging_hint_no_change%/,utils.a("paging.hint.no_change")),b=b.replace(/%direction%/g,utils.a("lang.direction")),a=a.replace(/%repeat-begin%(.|\s)*%repeat-end%/,
c+b);document.getElementById("notification").innerHTML=a;document.getElementById("notification_box").hidden=!1;document.getElementById("content_frame").removeEventListener("mouseover",utils.showPagingNotification,!0);reader.b.setBoolPref("paging_hint_shown",!0)},closeNotification:function(){document.getElementById("notification_box").hidden=!0;document.getElementById("content_frame").contentWindow.focus()},G:function(a){url=a+"/epubreader_nav.html";var c=Components.classes["@mozilla.org/network/io-service;1"].getService(Components.interfaces.nsIIOService).getProtocolHandler("file").QueryInterface(Components.interfaces.nsIFileProtocolHandler).getFileFromURLSpec(url).exists()?
"epubreader_nav.html":"nav.html";return a+"/"+c},openPage:function(a){var c="",b=!1,d=Components.classes["@mozilla.org/appshell/window-mediator;1"].getService(Components.interfaces.nsIWindowMediator),e=d.getEnumerator("navigator:browser");for("faq"==a?c="http://www.epubread.com/manual.php":"catalog"==a&&(c="about:epubcatalog");!b&&e.hasMoreElements();){a=e.getNext();for(var f=a.gBrowser,g=f.browsers.length,h=0;h<g;h++){var k=f.getBrowserAtIndex(h);if(c==unescape(k.currentURI.spec)){f.selectedTab=
f.tabContainer.childNodes[h];a.focus();b=!0;break}}}b||((b=d.getMostRecentWindow("navigator:browser"))?"delayedOpenTab"in b?b.delayedOpenTab(c):"openNewTabWith"in b&&b.openNewTabWith(c):window.open(c))}};window.addEventListener("DOMContentLoaded",reader.init,!0);window.addEventListener("unload",reader.unload,!0);window.addEventListener("DOMContentLoaded",utils.init,!0);reader.navigateSpine=reader.navigateSpine;reader.page=reader.page;utils.zoomFont=utils.zoomFont;utils.setBookmark=utils.setBookmark;
utils.save=utils.save;utils.lockToolbar=utils.lockToolbar;utils.showToolbarNotification=utils.showToolbarNotification;utils.openPage=utils.openPage;utils.saveWidth=utils.saveWidth;utils.toggleNavigationbar=utils.toggleNavigationbar;utils.simulateClick=utils.simulateClick;utils.toggleReadingStyle=utils.toggleReadingStyle;
